<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AppBuilder — Custom Builder</title>
    <link rel="stylesheet" href="/admin-static/style.css" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <!-- Include js-beautify for excellent HTML formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.15.1/beautify-html.min.js"></script>
    <!-- Load Montserrat for site typography -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- GrapesJS removed -->
    <style>
      /* Hide native scrollbars for overlay elements only; don't hide CodeMirror scrollbars */
      #editorHighlightLayer,
      #editorHighlightContent,
      #editorWrapper {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
      /* WebKit browsers */
      #editorHighlightLayer::-webkit-scrollbar,
      #editorHighlightContent::-webkit-scrollbar {
        width: 0px;
        height: 0px;
        background: transparent;
      }
      /* Ensure overlay doesn't show visible text (we rely on textarea for text) */
      #editorHighlightLayer,
      #editorHighlightContent {
        overflow: hidden;
      }
      /* Make CodeMirror editor fill the pageEditor container fully */
      .CodeMirror {
        height: 100% !important;
      }
      /* Editor fixed width while allowing vertical scrolling of content */
      :root {
        --editor-fixed-width: 760px;
      }
      #editorWrapper {
        overflow: auto;
      }
      #pageEditor {
        width: var(--editor-fixed-width);
        margin: 0 auto;
        box-sizing: border-box;
      }
      /* Highlight styles used when clicking preview elements */
      .cm-preview-highlight-root {
        background: rgba(59, 130, 246, 0.28);
        border: 2px solid rgba(59, 130, 246, 0.95);
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.12);
        border-radius: 6px;
      }
      .cm-preview-highlight-parent {
        background: rgba(250, 204, 21, 0.2);
        border: 2px solid rgba(250, 204, 21, 0.9);
        box-shadow: 0 6px 18px rgba(250, 204, 21, 0.08);
        border-radius: 6px;
      }
      .cm-preview-highlight-child {
        background: rgba(34, 197, 94, 0.18);
        border: 2px solid rgba(34, 197, 94, 0.92);
        box-shadow: 0 6px 18px rgba(34, 197, 94, 0.08);
        border-radius: 6px;
      }
    </style>
    <style>
      /* Palette: single harmonic dark style (minimal rules)
         This replaces multiple overrides with a single clear theme. */
      #dataPalette {
        font-family:
          Inter,
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          Arial;
        background: #071226;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: #e6eef8;
        padding: 12px;
        border-radius: 10px;
        width: 320px;
        max-width: 100%;
        box-shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
        overflow: auto;
      }
      #dataPalette .tree-root {
        margin-bottom: 8px;
      }
      #dataPalette .tree-node {
        margin: 6px 0;
      }
      #dataPalette .node-label {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 8px;
        cursor: grab;
        transition:
          background 0.12s,
          transform 0.12s;
      }
      #dataPalette .node-label:hover {
        background: rgba(255, 255, 255, 0.02);
        transform: translateY(-1px);
      }
      #dataPalette .api-handle {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: linear-gradient(180deg, #60a5fa, #3b82f6);
        box-shadow: 0 6px 14px rgba(59, 130, 246, 0.18);
        flex: 0 0 auto;
        margin-right: 8px;
      }
      #dataPalette .node-text {
        flex: 1;
        font-weight: 600;
        color: #e6eef8;
        font-size: 13px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #dataPalette .node-sample {
        color: #94a3b8;
        font-size: 12px;
        margin-left: 8px;
      }
      #dataPalette .node-value-badge {
        font-size: 11px;
        padding: 6px 8px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.03);
        color: #c7e7ff;
        border: 1px solid rgba(255, 255, 255, 0.04);
        margin-left: 8px;
      }
      #dataPalette .api-status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 6px;
      }
      #dataPalette .node-children {
        margin-left: 20px;
      }
      #dataPalette code {
        color: #c7e7ff;
        background: rgba(255, 255, 255, 0.02);
        padding: 2px 6px;
        border-radius: 4px;
      }
      /* small utility classes within preview area */
      .preview-wrap .muted,
      .muted {
        color: #9fb3c9 !important;
      }
    </style>
    <style>
      /* Layout for builder */
      .app-shell {
        display: flex;
        min-height: 100vh;
        align-items: flex-start;
        font-family: Montserrat, Inter, system-ui, Arial, sans-serif;
      }
      /* Sidebar and main both stretch to viewport height and scroll independently */
      .sidebar {
        width: 360px;
        padding: 18px;
        background: linear-gradient(180deg, #061423, #04101a);
        box-shadow: 2px 0 18px rgba(2, 6, 23, 0.4);
        box-sizing: border-box;
        height: auto; /* size to content so it matches explorer height */
        max-height: calc(100vh - 120px);
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
      }
      .main {
        flex: 1;
        padding: 18px;
        background: linear-gradient(180deg, #081424, #06101a);
        color: #e6eef8;
        min-height: 100vh;
        overflow: auto;
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .card {
        background: linear-gradient(180deg, #071226, #03121a);
        border-radius: 10px;
        padding: 12px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        box-shadow: 0 6px 20px rgba(2, 6, 23, 0.4);
      }
      .panel-row {
        margin-top: 12px;
      }
      .section-title {
        font-weight: 700;
        margin-bottom: 8px;
        color: #cfe9ff;
      }
      .site-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .site-list li {
        padding: 8px;
        border-radius: 8px;
        margin-bottom: 6px;
        cursor: pointer;
        color: #dbeffd;
      }
      .site-list li:hover {
        background: rgba(255, 255, 255, 0.02);
      }

      /* Palette simplified visuals */
      .simple-palette {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .palette-root {
        border-radius: 8px;
        overflow: hidden;
      }
      .palette-root-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        background: rgba(255, 255, 255, 0.02);
        font-weight: 700;
        color: #e6eef8;
      }
      /* Strong high-contrast rules for the variable palette in dark theme */
      #dataPalette,
      #dataPalette .simple-palette,
      #dataPalette .palette-root,
      #dataPalette .palette-root-header,
      #dataPalette .palette-children,
      #dataPalette .palette-row,
      #dataPalette .palette-key,
      #dataPalette .palette-sample {
        background: transparent !important;
        color: #e6eef8 !important;
      }
      #dataPalette {
        background: linear-gradient(180deg, #051226, #031018) !important;
        border: 1px solid rgba(255, 255, 255, 0.04) !important;
        box-shadow: 0 8px 32px rgba(2, 8, 20, 0.7) !important;
      }
      #dataPalette .palette-root-header {
        background: rgba(255, 255, 255, 0.02) !important;
      }
      #dataPalette .palette-row {
        border-radius: 6px;
      }
      #dataPalette .palette-key {
        color: #003366 !important;
        font-weight: 700;
      }
      #dataPalette .palette-sample {
        color: #9fb6d6 !important;
      }
      #dataPalette .palette-method {
        background: #12385c !important;
        color: #dff3ff !important;
      }
      #dataPalette .palette-caret {
        color: #9fb6d6 !important;
        margin-right: 8px;
        cursor: pointer;
      }
      /* Blue connect handle high contrast */
      #dataPalette .api-handle,
      #dataPalette .api-handle * {
        width: 14px !important;
        height: 14px !important;
        border-radius: 50% !important;
        background: linear-gradient(180deg, #60a5fa, #3b82f6) !important;
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.28) !important;
        border: 2px solid rgba(3, 37, 65, 0.6) !important;
        display: inline-block !important;
        vertical-align: middle !important;
        margin-left: 8px !important;
      }
      #dataPalette .api-handle:hover {
        box-shadow: 0 8px 28px rgba(59, 130, 246, 0.32) !important;
      }
      .palette-method {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.03);
        color: #cfe9ff;
        margin-left: 8px;
      }
      .palette-children {
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .palette-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 6px;
        cursor: grab;
      }
      .palette-row:hover {
        background: rgba(255, 255, 255, 0.02);
      }
      .palette-key {
        flex: 1;
        color: #e6eef8;
        font-weight: 600;
      }
      .api-handle {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: linear-gradient(180deg, #60a5fa, #3b82f6);
        box-shadow: 0 6px 14px rgba(59, 130, 246, 0.18);
        cursor: grab;
      }

      /* Responsive: collapse sidebar on small screens */
      @media (max-width: 900px) {
        .app-shell {
          flex-direction: column;
        }
        .sidebar {
          width: 100%;
          order: 2;
        }
        .main {
          order: 1;
        }
      }
      /* Visible high-contrast scrollbar for the sidebar */
      .sidebar::-webkit-scrollbar {
        width: 12px;
      }
      .sidebar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
      }
      .sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.06);
        border-radius: 8px;
        border: 2px solid rgba(3, 6, 10, 0.12);
      }
      /* Firefox scrollbar theming */
      .sidebar {
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.06) rgba(255, 255, 255, 0.02);
      }
    </style>
    <style>
      /* Ensure palette inside .light-bg keeps dark chrome (override .light-bg *) */
      .light-bg #dataPalette,
      .light-bg #dataPalette * {
        color: var(--text) !important;
      }
      .light-bg #dataPalette {
        background: linear-gradient(180deg, #071226, #03121a) !important;
        border: 1px solid rgba(255, 255, 255, 0.04) !important;
      }
      /* Make sure palette links/buttons remain visible */
      .light-bg #dataPalette .btn,
      .light-bg #dataPalette button {
        color: var(--text) !important;
      }
    </style>
    <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-markdown.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="brand">
          <svg
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <rect
              x="3"
              y="3"
              width="18"
              height="18"
              rx="4"
              fill="var(--accent)"
            />
            <path
              d="M7 12h10M7 8h10M7 16h6"
              stroke="#fff"
              stroke-width="1.4"
              stroke-linecap="round"
            />
          </svg>
          <div
            class="brand-title"
            style="
              margin-left: 10px;
              font-weight: 600;
              font-size: 14px;
              color: #cfe9ff;
            "
          >
            AppBuilder
          </div>
        </div>

        <div class="sidebar-section">
          <div class="section-title">Sites</div>
          <ul
            id="siteList"
            class="site-list"
            data-intro="List of your managed sites. Click to open."
          ></ul>
        </div>
      </aside>

      <main class="main">
        <header class="topbar">
          <div class="search">
            <div>Custom Page Builder</div>
          </div>
          <div class="top-actions">
            <a id="previewLink" class="btn outline" target="_blank" href="#"
              >Open Preview</a
            >
          </div>
        </header>

        <div class="content">
          <div class="panel" id="panelBuilder">
            <div
              class="card"
              id="cardPages"
              data-intro="Browse the selected website's folder and files. Click a file to open it in the editor."
            >
              <h3>Site Files</h3>
              <div class="muted">
                Browse the selected website's folder and files. Click a file to
                open it in the editor.
              </div>
              <div
                id="siteFileTree"
                style="
                  margin-top: 10px;
                  max-height: 360px;
                  overflow: auto;
                  padding: 8px;
                  background: rgba(255, 255, 255, 0.02);
                  border-radius: 8px;
                "
              ></div>
              <div style="display: flex; gap: 8px; margin-top: 8px">
                <input
                  id="newPageNameInput"
                  placeholder="new-page.html"
                  style="
                    flex: 1;
                    padding: 8px;
                    border-radius: 8px;
                    border: 1px solid rgba(255, 255, 255, 0.04);
                    background: transparent;
                  "
                />
                <button id="createPageBtn" class="btn small">
                  Create Page
                </button>
              </div>
              <div
                id="siteActions"
                class="muted small"
                style="margin-top: 8px"
              ></div>
            </div>

            <!-- GrapesJS modal removed -->
          </div>
          <!-- preview removed from inline layout; moved to full-width section below -->
        </div>
      </main>
    </div>
    <!-- Full-width preview section (spans the entire viewport width) -->
    <section
      class="full-preview-section"
      style="width: 100%; padding: 18px; box-sizing: border-box"
    >
      <div
        class="card"
        id="cardPreview"
        style="max-width: 1400px; margin: 0 auto"
      >
        <h3>Page Preview</h3>
        <div class="muted">
          Select a page to preview. Scripts are disabled in this preview for
          safety; click elements to highlight related code in the editor.
        </div>
        <div
          class="muted small"
          style="margin-bottom: 8px; color: #64748b; font-style: italic"
        >
          ℹ️ This sandboxed preview does not execute page scripts. Use "Open
          Preview" to open the live page in a new tab.
        </div>

        <div
          class="three-panel-row"
          style="
            display: flex;
            gap: 12px;
            align-items: flex-start;
            margin-top: 8px;
          "
        >
          <!-- Left: Variable Palette (25%) -->
          <div
            class="panel-left"
            style="flex: 0 0 25%; min-width: 220px; max-width: 360px"
          >
            <div class="muted small">Variable Palette (drag into preview)</div>
            <div
              id="dataPalette"
              style="
                margin-top: 8px;
                max-height: 420px;
                overflow: auto;
                padding: 8px;
              "
            ></div>
            <div class="muted small" style="margin-top: 12px">
              Tip: Drag an item to the preview to insert
              <code>{{api.path}}</code>. For loops, insert
              <code>{{#each api.path}}</code> and <code>{{/each}}</code> around
              a block and use <code>{{this.field}}</code> inside.
            </div>
          </div>

          <!-- Center: HTML Element Explorer (25%) -->
          <div
            class="panel-center"
            style="flex: 0 0 25%; min-width: 220px; max-width: 360px"
          >
            <div class="muted small">HTML Element Explorer</div>
            <div
              id="elementExplorer"
              style="
                margin-top: 8px;
                max-height: 420px;
                overflow: auto;
                padding: 8px;
                background: rgba(255, 255, 255, 0.01);
                border-radius: 6px;
                border: 1px solid rgba(255, 255, 255, 0.02);
              "
            ></div>
          </div>

          <!-- Right: Live Preview (50%) -->
          <div class="panel-right" style="flex: 1 0 50%; min-width: 360px">
            <div class="muted small">Live Preview</div>
            <div
              style="
                margin-top: 8px;
                height: 420px;
                border-radius: 8px;
                overflow: hidden;
                border: 1px solid rgba(0, 0, 0, 0.06);
                background: #fff;
              "
            >
              <iframe
                id="previewFrame"
                srcdoc=""
                sandbox="allow-scripts allow-same-origin allow-forms"
                referrerpolicy="no-referrer"
                style="
                  width: 100%;
                  height: 100%;
                  border: 0;
                  background: #fff;
                  color: #000;
                "
              ></iframe>
            </div>
            <div
              id="livePatchPreview"
              style="
                margin-top: 10px;
                padding: 8px;
                background: linear-gradient(180deg, #071226 0%, #03121a 100%);
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.03);
              "
            >
              <div class="muted small">Live Patch (Handlebars snippet)</div>
              <pre
                id="livePatchCode"
                style="
                  margin-top: 6px;
                  white-space: pre-wrap;
                  word-break: break-word;
                  background: transparent;
                  border-radius: 6px;
                  padding: 8px;
                  color: #c7e7ff;
                  overflow: auto;
                  max-height: 160px;
                "
              ></pre>
            </div>
          </div>
        </div>
        <textarea id="pageEditor" style="display: none"></textarea>
        <div
          id="editorSelectionInfo"
          style="
            display: none;
            margin-top: 8px;
            color: #9fb6d6;
            font-size: 12px;
          "
        >
          Selected: none
        </div>
      </div>
    </section>

    <script src="/admin-static/utils.js"></script>
    <script src="/admin-static/templates.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.15.1/beautify-html.min.js"></script>
    <script src="/admin-static/easybuild.js"></script>
  </body>
</html>
